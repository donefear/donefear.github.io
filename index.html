<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üçΩÔ∏è Meal Planner + Recipes</title>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; margin: 0; padding: 20px;}
h1 { text-align: center; color: #333; }
button { padding: 12px 25px; font-size: 16px; margin: 10px; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s; }
button:hover { opacity: 0.9; }
#meal, #recipes { margin-top: 20px; }
.recipe-card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
.recipe-card img { width: 100%; border-radius: 12px; margin-top: 10px; }
#progressContainer { width: 100%; background: #e0e0e0; border-radius: 10px; margin-top: 15px; height: 20px; overflow: hidden; display: none; }
#progressBar { width: 0%; height: 100%; background: #4caf50; transition: width 0.3s; }
#apiStatus { font-weight: bold; margin-top: 5px; font-size: 16px; display: flex; align-items: center;}
.spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4caf50; border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; margin-right: 8px; }
@keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
@media (min-width: 768px) { .recipes-container { display: grid; grid-template-columns: repeat(auto-fit,minmax(250px,1fr)); gap: 20px;} }
footer {
  background-color: #333;
  color: #fff;
  text-align: center;
  padding: 10px 0;
  font-size: 14px;
}

footer a {
  color: #f0a500; /* Link color */
  text-decoration: none;
}
</style>
</head>
<body>
<h1>üç¥ Meal Planner + Recipes</h1>
<div style="text-align:center;">
  <button style="background:#4caf50;color:white;" onclick="generateMeal()">Get Random Meal</button>
</div>
<div id="progressContainer"><div id="progressBar"></div></div>
<div id="apiStatus">Checking API connectivity...</div>
<div id="meal"></div>
<div id="recipes" class="recipes-container"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// Ingredient pools for random selection
const protein = ["chicken","turkey","beef","pork","salmon","tuna","shrimp","crab","eggs","tofu","lentils"];
const carbs = ["rice","quinoa","oats","pasta","bread","potato","sweet potato","corn","tortilla"];
const veggies = [
  "Carrot",
  "Leek",
  "Onion",
  "Cabbage",
  "Brussels Sprouts",
  "Cauliflower",
  "Spinach",
  "Endive (Chicory)",
  "Green Beans",
  "Peas",
  "Tomato",
  "Bell Pepper",
  "Zucchini",
  "Pumpkin",
  "Fennel",
  "Celery",
  "Radish",
  "Parsnip",
  "Beetroot",
  "Garlic",
  "Mushroom",
  "Chard"
];

// API keys for external services
const SPOONACULAR_KEY = 'b6e0fc154f2944e980d07b65e1cbb8a1';
const NINJAS_KEY = 'qMfricT/HUlPoA5/9+zjDQ==tddpjYFbKL6FSo4d';

// Utility: pick a random element from an array
function randomChoice(arr){return arr[Math.floor(Math.random()*arr.length)];}

// Progress bar handling
function showProgress(){document.getElementById('progressContainer').style.display='block'; document.getElementById('progressBar').style.width='0%';}
function updateProgress(percent,color='#4caf50'){const bar=document.getElementById('progressBar'); bar.style.width=percent+'%'; bar.style.background=color;}
function hideProgress(){document.getElementById('progressContainer').style.display='none';}

// Check connection to APIs when page loads
async function checkAPIConnection(){
  let status = '';
  try{ await fetchTheMealDB([randomChoice(protein), randomChoice(carbs)]); status += '‚úÖ TheMealDB OK '; }catch(e){ status += '‚ùå TheMealDB failed '; }
  try{ await fetchAPINinjas([randomChoice(protein), randomChoice(carbs)]); status += '‚úÖ API Ninjas OK '; }catch(e){ status += '‚ùå API Ninjas failed '; }
  try{ await fetchSpoonacular([randomChoice(protein), randomChoice(carbs)]); status += '‚úÖ Spoonacular OK'; }catch(e){ status += '‚ùå Spoonacular failed'; }
  document.getElementById('apiStatus').innerText = status;
}

// --- Recipe fetching with 3 stages ---
async function fetchRecipes(selProtein, selVeg, selCarb){
  const apis = [
    {name:'TheMealDB', fn:fetchTheMealDB},
    {name:'API Ninjas', fn:fetchAPINinjas},
    {name:'Spoonacular', fn:fetchSpoonacular}
  ];
  showProgress();

  const stages = [
    { label: "Stage 1: protein + carb + veg", ing: [selProtein, selCarb, selVeg] },
    { label: "Stage 2: protein + carb", ing: [selProtein, selCarb] },
    { label: "Stage 3: protein only", ing: [selProtein] }
  ];

  for (let s = 0; s < stages.length; s++) {
    const stage = stages[s];
    document.getElementById('apiStatus').innerHTML = `üîé ${stage.label}`;

    for (let i = 0; i < apis.length; i++) {
      const api = apis[i];
      document.getElementById('apiStatus').innerHTML =
        `<div class="spinner"></div>Trying ${api.name} ‚Äî ${stage.label}...`;

      try {
        let recipes = await api.fn(stage.ing);

        // Reset bar per stage
        updateProgress(Math.floor(((i+1)/apis.length) * 100));

        // Require protein
        recipes = recipes.filter(r => {
          const text = (r.strMeal + ' ' + (r.strCategory || '') + ' ' + (r.strArea || '')).toLowerCase();
          return text.includes(selProtein.toLowerCase());
        });

        if (recipes.length > 0) {
          hideProgress();
          document.getElementById('apiStatus').innerHTML = `‚úÖ Found recipes using ${stage.label}`;
          return recipes;
        }
      } catch (e) {
        updateProgress(Math.floor(((i+1)/apis.length) * 100), '#f44336');
        document.getElementById('apiStatus').innerHTML =
          `‚ùå ${api.name} failed during ${stage.label}`;
      }
    }
  }

  hideProgress();
  document.getElementById('apiStatus').innerHTML = `‚ö†Ô∏è No recipes found in any stage`;
  return [];
}


// --- API-specific fetchers ---
async function fetchTheMealDB(ingredients){
  const resp = await fetch(`https://www.themealdb.com/api/json/v1/1/filter.php?i=${encodeURIComponent(ingredients.join(','))}`);
  if(!resp.ok) throw new Error('TheMealDB request failed');
  const data = await resp.json();
  if(!data.meals) return [];
  let detailed=[];
  for(const meal of data.meals.slice(0,5)){
    const det = await fetch(`https://www.themealdb.com/api/json/v1/1/lookup.php?i=${meal.idMeal}`).then(r=>r.json());
    if(det.meals && det.meals[0]) detailed.push(det.meals[0]);
  }
  return detailed;
}

async function fetchAPINinjas(ingredients){
  const resp = await fetch(`https://api.api-ninjas.com/v1/recipe?query=${encodeURIComponent(ingredients.join(' '))}&limit=5`, {headers:{'X-Api-Key':NINJAS_KEY}});
  if(!resp.ok) throw new Error('API Ninjas request failed');
  const data = await resp.json();
  return data.map(r => ({strMeal:r.title,strMealThumb:r.image||'',strCategory:r.category||'N/A',strArea:r.cuisine||'N/A',strSource:r.url||`https://api-ninjas.com/recipe/${encodeURIComponent(r.title)}`,instructions:r.instructions||'No instructions available'}));
}

async function fetchSpoonacular(ingredients){
  const resp = await fetch(`https://api.spoonacular.com/recipes/complexSearch?apiKey=${SPOONACULAR_KEY}&includeIngredients=${ingredients.join(',')}&number=5&addRecipeInformation=true`);
  if(!resp.ok) throw new Error('Spoonacular request failed');
  const data = await resp.json();
  return data.results.map(r => ({strMeal:r.title,strMealThumb:r.image||'',strCategory:r.dishTypes ? r.dishTypes.join(', ') : 'N/A',strArea:r.cuisines ? r.cuisines.join(', ') : 'N/A',strSource:r.sourceUrl||`https://spoonacular.com/recipes/${encodeURIComponent(r.title)}`,instructions:r.instructions||'No instructions available'}));
}

// --- Main: Generate Random Meal ---
async function generateMeal(){
  const selProtein=randomChoice(protein);
  const selCarb=randomChoice(carbs);
  const selVeg=randomChoice(veggies);

  document.getElementById('meal').innerHTML=`<div class="day"><h2>Your Random Meal</h2><p><strong>Protein:</strong> ${selProtein}</p><p><strong>Carb:</strong> ${selCarb}</p><p><strong>Vegetable:</strong> ${selVeg}</p></div>`;
  document.getElementById('recipes').innerHTML='<p>Searching for recipes...</p>';

  const recipes = await fetchRecipes(selProtein, selVeg, selCarb);
  const recipesDiv = document.getElementById('recipes');

  if(recipes.length===0) recipesDiv.innerHTML=`<p>No recipes found with the selected ingredients.</p>`;
  else{
    recipesDiv.innerHTML='';
    recipes.forEach(m=>{
      const card = document.createElement('div');
      card.className = 'recipe-card';
      card.innerHTML = `<h3>${m.strMeal}</h3><img src='${m.strMealThumb}' alt='${m.strMeal}'><p><strong>Category:</strong> ${m.strCategory||'N/A'}</p><p><strong>Area:</strong> ${m.strArea||'N/A'}</p><p><strong>Instructions:</strong> ${m.strInstructions || m.instructions || 'No instructions available'}</p><p><a href='${m.strSource||''}' target='_blank'>View Full Recipe</a></p>`;
      recipesDiv.appendChild(card);
    });
  }
}

// Run API connection check at startup
checkAPIConnection();
</script>
<footer>
  &copy; 2025 DoneFear. All rights reserved. |
</footer>
</body>
</html>

